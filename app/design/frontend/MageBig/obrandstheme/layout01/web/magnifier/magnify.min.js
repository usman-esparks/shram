define(["jquery","underscore","magnifier/magnifier"],function(L,W){"use strict";return function(g,a){var e,r,y,C,M,t,b="ontouchstart"in document.documentElement,E='[data-gallery-role="gallery"]',o='[data-gallery-role="magnifier"]',n='[data-gallery-role="magnifier-zoom"]',c='[data-gallery-role="fotorama__zoom-in"]',v='[data-gallery-role="fotorama__zoom-out"]',k='[data-gallery-role="stage-shaft"] [data-active="true"] .fotorama__img--full',S="fotorama__img--draggable",m="fotorama__img--zoommable",i="zoom-in-loaded",h="zoom-out-loaded",p="fotorama__zoom-in--disabled",w="fotorama__zoom-out--disabled",s="fotorama-video-container",P=!1,z=0,O=!1,T=!0;function F(t){return{rw:t.naturalWidth,rh:t.naturalHeight}}function l(t){var e,o,a=t.height(),n=t.width(),i=t.parent().height(),r=t.parent().width();(r<n||i<a)&&(n/a<r/i?o=n*((e=i)/a):e=a*(o=r)/n,t.css({"min-width":o,"min-height":e}))}function $(t,e){e?t.css({"min-width":t.width(),"min-height":t.height(),width:t.width(),height:t.height()}).addClass(m):(t.css({width:"",height:"",top:"",left:"",right:"",bottom:""}).removeClass(m),l(t))}function f(t){O=y=P=!(T=!0),t.hasClass(S)&&t.removeClass(S),$(t,!1)}function d(t){t?(L(c).addClass(p),L(v).addClass(w)):(L(c).removeClass(p),L(v).removeClass(w))}function _(t,e,o){var a=t.attr("src");!a||e||o?d(!0):function(t,e){var o=new Image;o.onload=function(){this.height>e.parent().height()||this.width>e.parent().width()?d(!1):d(!0)},o.src=t}(a,t)}function Y(t,e){var o,a,n,i,r;t.data.$image&&t.data.$image.length&&(o=F(L(k)[0]),a=t.data.$image.parent().width(),n=t.data.$image.parent().height(),i=a>=o.rw&&n>=o.rh,r=a>t.data.$image.width()&&n>t.data.$image.height(),_(t.data.$image,b,I(t.data.fotorama.activeFrame.$stageFrame)),l(t.data.$image),(t.data.$image.hasClass(m)&&!O||i||r)&&f(t.data.$image),i||x())}function D(t,e,o,a){var n,i,r,h,s,l,f,d;L(E).data("fotorama").fullScreen&&(P=!0,i=(n=t.parent()).width(),r=n.height(),s=t.position().top,l=t.position().left,d=t.width()/t.height(),e.height=isNaN(e.height)?e.width/d:e.height,e.width=isNaN(e.width)?e.height*d:e.width,s=e.height>=r?function(t,e,o,a,n){var i;return parseInt(t.css("marginTop"))||parseInt(t.css("marginLeft"))?i=a-n<(i=(i=y?e-o/4:0)<n-a?n-a:i)?a-n:i:(i=0<(i=(i=e+o/2)<n-a?n-a:i)?0:i,!y&&o<0&&(i=i<(n-a)/2?(n-a)/2:i)),i}(t,s,a,e.height,r):0,l=e.width>=i?function(t,e,o,a){var n;return n=0<(n=(n=t+e/2)<a-o?a-o:n)?0:n,!y&&e<0&&(n=n<(a-o)/2?(a-o)/2:n),n}(l,o,e.width,i):0,f=y&&l<(i-e.width)/2?0:l,h=L.extend(e,{top:s,left:l,right:f}),t.css(h))}function x(){var e,t=L("a[href], area[href], input, select, textarea, button, iframe, object, embed, *[tabindex], *[contenteditable]").not("[tabindex=-1], [disabled], :hidden"),o=L(E).data("fotorama"),a=L(":focus");o.fullScreen&&(t.each(function(t){L(this).is(a)&&(e=t)}),o.setOptions({swipe:!O,keyboard:!O}),W.isNumber(e)&&t.eq(e).focus())}function X(t,e,o){var a,n,i,r,h,s,l,f,d,u={};return!T||M&&P||!b&&L(c).hasClass(p)||(n=F((a=L(k))[0]),d=(i=a.width())/(r=a.height()),O=!0,x(),a.hasClass(m)||$(a,!0),t.preventDefault(),r<=i?((l=i+(h=e||Math.ceil(i*parseFloat(g.magnifierOpts.fullscreenzoom)/100)))>=n.rw&&(l=n.rw,h=e||l-i,T=!1),f=l/d,s=o||f-r):((f=r+(s=o||Math.ceil(r*parseFloat(g.magnifierOpts.fullscreenzoom)/100)))>=n.rh&&(f=n.rh,s=o||f-r,T=!1),l=f*d,h=e||l-i),r<=i&&i!==n.rw?D(a,u=L.extend(u,{width:l,height:"auto"}),-h,-s):i<r&&r!==n.rh&&D(a,u=L.extend(u,{width:"auto",height:f}),-h,-s)),!1}function N(t,e,o){var a,n,i,r,h,s,l,f,d,u,c,m;return!O||M&&P||!b&&L(v).hasClass(w)||(T=!0,a=L(k),h=a.parent().width(),s=a.parent().height(),l=a.width(),f=a.height(),c=l/f,t.preventDefault(),f<=l?(d=e||Math.ceil(l*parseFloat(g.magnifierOpts.fullscreenzoom)/100),i=(n=l-d)/c,u=o||f-i):(u=o||Math.ceil(f*parseFloat(g.magnifierOpts.fullscreenzoom)/100),n=(i=f-u)*c,d=e||l-n),m=function(){r=h/s<c?(d=l-(n=h),u=f-(i=n/c),{width:n,height:"auto"}):(u=f-(i=s),d=l-(n=i*c),{width:"auto",height:i}),D(a,r,d,u)},f<=l?h<n?D(a,r={width:n,height:"auto"},d,u):s<i?D(a,r={width:n,height:"auto"},d,u):(O=y=!1,x(),m()):s<i?D(a,r={width:"auto",height:i},d,u):h<n?D(a,r={width:"auto",height:i},d,u):(O=y=!1,x(),m())),!1}function u(t){var n,i,r,h,s,l,f,d=!1,u=L(E),c=L(k,u),m=L('[data-gallery-role="stage-shaft"] [data-active="true"]'),g=u.data("fotorama");function v(t){return parseInt(t.get(0).style.top)}function p(t,e,o){var a=+h+e,n=+r+t,i=c.width()/10+20;return y=!0,c.offset().left===m.offset().left+m.width()-c.width()&&39===o.keyCode||C-1<m.offset().left+m.width()-c.width()&&t<0&&W.isNumber(C)&&("mousemove"===o.type||"touchmove"===o.type||"pointermove"===o.type||"MSPointerMove"===o.type)?(C=null,void l(">")):c.offset().left===m.offset().left&&0!==t&&37===o.keyCode||C===m.offset().left&&0<t&&("mousemove"===o.type||"touchmove"===o.type||"pointermove"===o.type||"MSPointerMove"===o.type)?(C=null,void l("<")):(c.height()>m.height()&&(m.height()>c.height()+a?c.css("top",m.height()-c.height()):(e=e<(a=c.height()-v(c)-m.height())?e:a,c.css("top",v(c)+e))),c.width()>m.width()?(n=m.offset().left+m.width()>n+c.width()?m.offset().left+m.width()-c.width():m.offset().left<n?m.offset().left:n,c.offset({left:n}),c.css("right","")):Math.abs(e)<1&&O&&"mousemove"!==o.type&&"touchmove"!==o.type&&"pointermove"!==o.type&&"MSPointerMove"!==o.type&&(t<0?L(E).data("fotorama").show(">"):L(E).data("fotorama").show("<")),void(c.width()<=m.width()&&O&&("mousemove"===o.type||"touchmove"===o.type||"pointermove"===o.type||"MSPointerMove"===o.type)&&Math.abs(t)>Math.abs(e)&&Math.abs(t)>i&&l(t<0?">":"<")))}function o(t){var e,o=F(c[0]);o.rh<c.parent().height()&&o.rw<c.parent().width()||(e=o.rw/o.rh,T?X(t,o.rw-c.width(),o.rh-c.height()):e>m.width()/m.height()?N(t,o.rw-m.width(),o.rw/e):N(t,o.rw*e,o.rh-m.height()))}function w(t){return Math.sqrt((t.touches[0].clientX-t.touches[1].clientX)*(t.touches[0].clientX-t.touches[1].clientX)+(t.touches[0].clientY-t.touches[1].clientY)*(t.touches[0].clientY-t.touches[1].clientY))}l=W.throttle(function(t){L(E).data("fotorama").show(t)},500,{trailing:!1}),b?(c.off("tap"),c.on("tap",function(t){0===t.originalEvent.originalEvent.touches.length&&function(t){var e=(new Date).getTime()-z;e<400&&0<e?(P=!1,z=0,o(t)):z=(new Date).getTime()}(t)})):(c.unbind("dblclick"),c.dblclick(o)),g.fullScreen&&_(c,b,I(t.activeFrame.$stageFrame)),c.off(b?"touchstart":"pointerdown mousedown MSPointerDown"),c.on(b?"touchstart":"pointerdown mousedown MSPointerDown",function(t){t&&t.originalEvent.touches&&2<=t.originalEvent.touches.length?(t.preventDefault(),f=w(t.originalEvent),d=!1,c.hasClass(S)&&c.removeClass(S)):!g.fullScreen||M&&P||(h=v(c),r=c.offset().left,b&&(s=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0],t.clientX=s.pageX,t.clientY=s.pageY),n=t.clientX||t.originalEvent.clientX,i=t.clientY||t.originalEvent.clientY,d=!0),c.offset()&&c.width()>m.width()&&(C=c.offset().left)}),c.off(b?"touchmove":"mousemove pointermove MSPointerMove"),c.on(b?"touchmove":"mousemove pointermove MSPointerMove",function(t){if(t&&t.originalEvent.touches&&2<=t.originalEvent.touches.length){t.preventDefault();var e=w(t.originalEvent);c.hasClass(S)&&c.removeClass(S),e<f?(N(t),f=e):f<e&&(X(t),f=e)}else{var o,a;!g.fullScreen||!d||M&&P||(O&&!c.hasClass(S)&&c.addClass(S),o=t.clientX||t.originalEvent.clientX,a=t.clientY||t.originalEvent.clientY,t.preventDefault(),b&&(o=(s=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0]).pageX,a=s.pageY),O&&(h=v(L(k,u)),p(o-n,a-i,t)))}}),c.off("transitionend webkitTransitionEnd mozTransitionEnd msTransitionEnd "),c.on("transitionend webkitTransitionEnd mozTransitionEnd msTransitionEnd",function(){P=!1}),e&&L(document).unbind("keydown",e),e=function(t){function e(){r=L(k,u).offset().left,h=v(L(k,u))}var o=L(":focus"),a=L(E).data("fotorama").fullScreen;!o.attr("data-gallery-role")&&o.length||!O||(a&&(r=L(k,L(E)).offset().left,h=v(L(k,L(E)))),39===t.keyCode&&a&&(e(),p(-40,0,t)),38===t.keyCode&&a&&(e(),p(0,40,t)),37===t.keyCode&&a&&(e(),p(40,0,t)),40===t.keyCode&&a&&(t.preventDefault(),e(),p(0,-40,t))),27===t.keyCode&&a&&O&&L(E).data("fotorama").cancelFullScreen()},L(document).keydown(e),L(document).on(b?"touchend":"mouseup pointerup MSPointerUp",function(t){g.fullScreen&&(c.offset()&&c.width()>m.width()&&(C=c.offset().left),d=!1,c.removeClass(S))}),L(window).off("resize",Y),L(window).on("resize",{$image:c,fotorama:t},Y)}function I(t){return t.hasClass(s)}return(b=b&&(navigator.maxTouchPoints||navigator.msMaxTouchPoints)&&navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone/i))&&L(a).on("fotorama:showend fotorama:load",function(){L(o).remove(),L(n).remove()}),void 0!==(t=document.documentElement.style).transition||void 0!==t.WebkitTransition||void 0!==t.MozTransition||void 0!==t.MsTransition||t.OTransition,r=function(){L(o).empty().hide(),L(n).remove()},g.magnifierOpts.enabled&&L(a).on("pointerdown mousedown MSPointerDown",function(t){var e=[t.pageX,t.pageY];L(a).on("mousemove pointermove MSPointerMove",function(t){navigator.msPointerEnabled?r():function(t,e){var o=[t.pageX,t.pageY],a="arrow"===L(t.target).data("gallery-role"),n=e[0]===o[0]&&e[1]===o[1],i=L(t.target).parent().data("active");(a||i&&!n)&&r()}(t,e)}),L(document).on("mouseup pointerup MSPointerUp",function(){L(a).off("mousemove pointermove MSPointerMove")})}),L.extend(g.magnifierOpts,{zoomable:!1,thumb:".fotorama__img",largeWrapper:'[data-gallery-role="magnifier"]',height:g.magnifierOpts.height||function(){return L('[data-active="true"]').height()},width:g.magnifierOpts.width||function(){var t=L(E).parent().parent();return t.parent().width()-t.width()-20},left:g.magnifierOpts.left||function(){return L(E).offset().left+L(E).width()+20},top:g.magnifierOpts.top||function(){return L(E).offset().top}}),L(a).on("fotorama:load fotorama:showend fotorama:fullscreenexit fotorama:ready",function(t,e){var o=L(E).data("fotorama").activeFrame.$stageFrame;o.find(n).length||(r(),g.magnifierOpts&&(g.magnifierOpts.large=L(E).data("fotorama").activeFrame.img,g.magnifierOpts.full=e.data[e.activeIndex].original,I(o)||L(o).magnify(g.magnifierOpts)))}),L(a).on("gallery:loaded",function(t){var o;L(a).find(E).on("fotorama:ready",function(t,e){var o=L(c),a=L(v);o.hasClass(i)||(o.on("click touchstart",X),o.on("mousedown",function(t){t.stopPropagation()}),o.keyup(function(t){13===t.keyCode&&X(t)}),L(window).keyup(function(t){107!==t.keyCode&&!e.fullscreen||X(t)}),o.addClass(i)),a.hasClass(h)||(a.on("click touchstart",N),a.on("mousedown",function(t){t.stopPropagation()}),a.keyup(function(t){13===t.keyCode&&N(t)}),L(window).keyup(function(t){109!==t.keyCode&&!e.fullscreen||N(t)}),a.addClass(h))}).on("fotorama:fullscreenenter fotorama:showend",function(t,e){r(),L(k).is(o)||f(L(k)),u(e),function(t,e){var o=e.activeFrame.$stageFrame,a=o.get(0);function n(t){var e=t.deltaY||t.wheelDelta,o=t||window.event;L(E).data("fotorama").fullScreen&&(t.deltaY?0<e?N(o):X(o):0<e?X(o):N(o),t.preventDefault?t.preventDefault():t.returnValue=!1)}o.hasClass("magnify-wheel-loaded")||a&&a.addEventListener&&("onwheel"in document?a.addEventListener("wheel",n):"onmousewheel"in document?a.addEventListener("mousewheel",n):a.addEventListener("MozMousePixelScroll",n),o.addClass("magnify-wheel-loaded"))}(0,e),o&&(l(o),L(k).is(o)||f(o)),x()}).on("fotorama:load",function(t,e){L(E).data("fotorama").fullScreen&&_(L(k),b,I(e.activeFrame.$stageFrame)),u(e)}).on("fotorama:show",function(t,e){o=W.clone(L(k)),r()}).on("fotorama:fullscreenexit",function(t,e){f(L(k)),r(),d(!0)})}),g}});